# 毕业典礼照片批量下载工具使用说明 v4.0

## 🎯 功能概述

这是一个专门用于从 xxpie.com 网站批量下载毕业典礼照片的工具，**v4.0版本支持高速并发下载**，专为大量照片优化：

### 🚀 v4.0 重大升级
- ✅ **多线程并发下载** - 速度提升5-10倍，适合3000+张照片
- ✅ **智能线程管理** - 可配置并发数，适应不同网络环境
- ✅ **线程安全设计** - 稳定可靠的并发处理
- ✅ **实时进度统计** - 显示下载速度和完成情况
- ✅ **失败重试机制** - 自动重试失败的下载

### 📋 继承功能
- ✅ **使用官方API获取照片列表** - 更稳定可靠
- ✅ **支持多种图片质量选择** - 从缩略图到原图
- ✅ **显示详细文件信息** - 大小、分辨率、数量统计
- ✅ **智能访问令牌提取** - 自动处理认证
- ✅ **分页获取完整列表** - 支持大量照片的相册

## 🚀 快速开始

### ⚡ 一键开始（推荐）
```bash
python photo_downloader.py
# 直接按回车使用默认相册
# 选择图片质量（推荐选择 7-原图）
# 确认开始下载
```

### 1. 运行脚本
```bash
python photo_downloader.py
```

### 2. 输入相册URL
程序会提示输入相册页面URL，可以直接按回车使用默认URL，或输入自定义URL：

**默认相册URL（按回车直接使用）：**
```
https://www.xxpie.com/m/album?id=684fe6d7e66eb911b3071bc3&nowatermark=Njg0ZmU2ZDdlNjZlYjkxMWIzMDcxYmMzJDA=&mini=0
```

**URL格式说明：**
- 必须以 `https://www.xxpie.com/m/album` 开头
- 包含相册ID参数：`id=684fe6d7e66eb911b3071bc3`
- 可选无水印参数：`nowatermark=...`
- 其他可选参数：`mini=0` 等

### 3. 设置下载目录
可以自定义下载目录，默认为 `graduation_photos`

### 4. 配置并发数
选择合适的并发线程数：
- **网络较慢**: 4-8 线程
- **网络一般**: 8-16 线程
- **网络较快**: 16-32 线程
- **默认推荐**: 8 线程

### 5. 选择图片质量
程序会提供7种质量选项：
- **缩略图** (thumbnail) - 最小文件
- **500px** (large500) - 小文件
- **800px** (large800) - 中等文件
- **1024px** (large1024) - 较大文件
- **1920px** (large) - 大文件
- **2560px** (large1920) - 超大文件
- **原图** (origin) - 最大文件，最高质量 ⭐️推荐

### 6. 确认下载
程序会显示：
- 找到的图片数量
- 预计总文件大小
- 前5张图片的详细信息（文件名、大小、分辨率）
- 并发线程数设置
- 确认后开始高速并发下载

## � 完整使用流程示例

```bash
$ python photo_downloader.py

毕业典礼照片批量下载工具 v4.0 (并发版本)
============================================================
🚀 v4.0 新功能:
• 多线程并发下载，速度大幅提升
• 智能进度显示和统计信息
• 线程安全的文件处理
• 失败重试机制
• 支持大量图片的高效下载
============================================================
📋 继承功能:
• 使用官方API获取照片列表
• 支持多种图片质量选择
• 显示文件大小和分辨率信息
• 改进的错误处理机制
============================================================

默认相册URL:
https://www.xxpie.com/m/album?id=684fe6d7e66eb911b3071bc3&nowatermark=Njg0ZmU2ZDdlNjZlYjkxMWIzMDcxYmMzJDA=&mini=0

请输入相册页面URL (直接按回车使用默认URL): [直接按回车]
✅ 使用默认相册URL

请输入下载目录 (默认: graduation_photos): [直接按回车或输入自定义目录]

⚙️  并发设置:
推荐并发数:
• 网络较慢: 4-8 线程
• 网络一般: 8-16 线程
• 网络较快: 16-32 线程
请输入并发线程数 (默认: 8): [直接按回车或输入数字]

请选择下载图片质量:
1. 缩略图 (thumbnail) - 最小文件
2. 500px (large500) - 小文件
3. 800px (large800) - 中等文件
4. 1024px (large1024) - 较大文件
5. 1920px (large) - 大文件
6. 2560px (large1920) - 超大文件
7. 原图 (origin) - 最大文件，最高质量
请选择 (1-7，默认选择原图): 7

确认开始处理相册？(y/N): y

开始处理相册: https://www.xxpie.com/m/album?id=...
相册ID: 684fe6d7e66eb911b3071bc3
✅ 找到访问令牌
正在获取照片列表...
获取第1页: 60张照片
✅ 成功获取 60 张照片信息

📊 图片信息统计:
图片数量: 60
选择质量: origin
预计总大小: 180.5 MB

前5张图片预览:
  1. R5L_0934.jpg (3.1MB) 3907x2604
  2. R5L_0932.jpg (3.2MB) 3967x2644
  3. R5L_0930.jpg (2.9MB) 4000x2666
  4. R5L_0928.jpg (3.1MB) 4000x2666
  5. R5L_0926.jpg (2.8MB) 3840x2560
  ... 还有 55 张图片

确认下载这 3749 张图片？(y/N): y

🚀 开始并发下载 3749 张图片...
📊 并发线程数: 8
============================================================
[1/3749] 完成: R5L_0934.jpg (3.1MB)
[2/3749] 完成: R5L_0932.jpg (3.2MB)
[3/3749] 跳过: R5L_0930.jpg (2.9MB)
[4/3749] 完成: R5L_0928.jpg (3.1MB)
...

📊 总进度: 13.3% (500/3749) - 成功:485, 跳过:12, 失败:3

...

============================================================
📊 下载完成统计:
   总数量: 3749
   成功: 3720
   跳过: 25
   失败: 4
   耗时: 285.6秒
   平均速度: 13.1张/秒

🎉 下载完成！共成功下载 3720 张图片
📁 文件保存在: graduation_photos
```

## �🔧 v3.0 重大升级

### 1. 🚀 API驱动架构
- **官方API调用**：使用 `https://int.xxpie.com/api/pm/queryAlbumItemsPgByDefaultSort`
- **自动分页**：支持大量照片的相册，自动获取所有页面
- **完整数据**：获取文件名、大小、分辨率等完整信息
- **稳定可靠**：不依赖页面HTML解析，更不容易失效

### 2. 🎨 多质量支持
```python
quality_options = {
    'thumbnail': 'url_thumbnail',      # 缩略图
    'large500': 'url_large500',        # 500px
    'large800': 'url_large800',        # 800px
    'large1024': 'url_large1024',      # 1024px
    'large': 'url_large',              # 1920px
    'large1920': 'url_large1920',      # 2560px
    'origin': 'url_origin'             # 原图
}
```

### 3. 🔐 智能认证
- **自动令牌提取**：从页面中自动提取访问令牌
- **无缝认证**：自动处理API认证，无需手动配置
- **降级处理**：令牌获取失败时尝试无认证访问

### 4. 📊 详细信息显示
- **文件统计**：显示总数量、总大小
- **单文件信息**：文件名、大小、分辨率
- **下载进度**：实时显示当前进度和文件信息
- **质量预览**：下载前显示所选质量的详细信息

## 📁 输出文件

下载完成后，目录结构如下：
```
graduation_photos/
├── page_content.html    # 页面内容（调试用）
├── R5L_0934.jpg        # 下载的照片
├── R5L_0935.jpg
└── ...
```

## 🐛 调试功能

如果遇到问题，可以：

1. **查看页面内容**：程序会自动保存 `page_content.html` 文件
2. **运行测试**：使用 `python test_downloader.py` 验证功能
3. **启用调试模式**：修改代码中的 `debug=True`

## ⚠️ 注意事项

1. **合法使用**：请确保已获得合法授权
2. **遵守条款**：请遵守网站使用条款
3. **合理频率**：内置1秒延迟，避免对服务器造成压力
4. **网络环境**：确保网络连接稳定

## 🔍 故障排除

### 问题1：找不到图片链接
- 检查URL格式是否正确
- 查看保存的 `page_content.html` 文件
- 确认页面是否需要登录

### 问题2：下载失败
- 检查网络连接
- 确认图片URL是否有效
- 使用重试功能

### 问题3：文件名乱码
- 程序会自动处理URL解码
- 不安全字符会被替换为下划线

## 📊 性能特点

- **内存友好**：使用流式下载，不会占用大量内存
- **网络优化**：合理的请求间隔和超时设置
- **错误恢复**：自动重试机制，提高成功率

## ⚡ 性能优化建议

### 🚀 并发数设置
- **3000+张照片**: 推荐16-32线程
- **1000-3000张**: 推荐8-16线程
- **少于1000张**: 推荐4-8线程
- **网络不稳定**: 降低并发数到4-8

### 💾 存储优化
- 确保有足够的磁盘空间（原图约3-5MB/张）
- 使用SSD硬盘可提升写入速度
- 避免在系统盘下载大量文件

### 🌐 网络优化
- 使用稳定的网络连接
- 避免在网络高峰期下载
- 如遇频繁失败，可降低并发数

### 📊 预期性能
- **串行下载**: 约1-2张/秒
- **8线程并发**: 约8-15张/秒
- **16线程并发**: 约15-25张/秒
- **实际速度取决于网络条件和服务器响应**

## 🔄 版本历史

### v4.0 (当前版本)
- 🚀 多线程并发下载
- 📊 智能进度统计
- 🔒 线程安全设计
- 🔄 失败重试机制
- ⚡ 性能大幅提升

### v3.0 (API版本)
- 使用官方API获取照片列表
- 支持多种图片质量选择
- 智能访问令牌提取
- 分页获取完整列表

### v2.0 (优化版本)
- 重构URL提取逻辑
- 增强请求头模拟
- 添加进度显示
- 改进错误处理

### v1.0 (原始版本)
- 基础下载功能
- 简单的URL提取

## 📁 项目结构

```
Claude-1/
├── README.md                    # 项目说明文档
├── photo_downloader.py          # 主程序文件
├── requirements.txt             # Python依赖包
├── .gitignore                   # Git忽略文件配置
├── graduation_photos/           # 下载的照片目录（不上传到Git）
└── tests/                       # 测试和演示文件夹
    ├── README.md                # 测试文件说明
    ├── test_downloader.py       # 核心功能测试
    ├── test_concurrent.py       # 并发功能测试
    ├── quick_test.py            # 快速功能验证
    ├── demo_api.py              # API功能演示
    └── performance_demo.py      # 性能对比演示
```

## 🧪 测试和演示

### 运行测试
```bash
# 核心功能测试
python tests/test_downloader.py

# 并发功能测试
python tests/test_concurrent.py

# 快速验证
python tests/quick_test.py
```

### 查看演示
```bash
# API功能演示
python tests/demo_api.py

# 性能对比演示
python tests/performance_demo.py
```

---

**免责声明**：本工具仅供学习交流使用，请勿用于商业用途。使用前请确保已获得相关授权。
